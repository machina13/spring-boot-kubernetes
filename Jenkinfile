pipeline {
    agent any 
    stages {
        stage('SAST') {
            steps {
                sh 'chmod +x mvnw'
                sh './mvnw clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.login=eb402dfd87ab83bfa88e9047d9c7add47053da27 -Dsonar.branch.name=master -Dsonar.host.url=https://sonarcloud.io -Dsonar.projectKey=machina13_spring-boot-kubernetes -Dsonar.organization=machina13'
            }
        }
	stage('Check Quality Gate') {
            steps {
                script {
	                timeout(time: 5, unit: 'MINUTES') {
                        qualitygate = waitForQualityGate();
                        if (qualitygate.status != "OK") {
                            currentBuild.result = "UNSTABLE"
                            error "Pipeline job aborted due to Sonar Quality Gate failure"
	                       }
        	            }
			}
		}
	}
    }
}

